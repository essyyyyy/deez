_G.AutofarmSettings = {
    ["AttackMode"] = "2",
    ["Fps"] = "10",
    ["Codes"] = {
        "ExampleCode1", 
        "ExampleCode2"
    }, 
    ["Webhook"] = "https://discord.com/api/webhooks/1230945277905473547/_Lqiea21Z-HUeon5FdmC7y6qe8iV_gyRSCcvCW3zlBsy0a_meh8rPK2zP40oTz2SCNlx",
    ["LogInterval"] = "2",
    ["Credits"] = "iku autofarm - by @trans"
}

loadstring(game:HttpGet("https://github.com/applless/RandomScripts/raw/main/IkuAutofarm"))()

local gameId = 2788229376
local previousServers = {}
local executionCount = 0  -- Track the number of executions

local player = game.Players.LocalPlayer

local function getTimestamp()
    return os.date("%Y-%m-%d %H:%M:%S", os.time())
end

-- Function to send logs to the Discord webhook
local function sendLog(message)
    local link = _G.AutofarmSettings.Webhook
    if link ~= "" then
        local data = {
            ["content"] = "",
            ["embeds"] = {{
                ["title"] = "**Autofarm Execution Debrainers**",
                ["description"] = message,
                ["color"] = tonumber(0x2B6BE4),
                ["footer"] = { ["text"] = "Timestamp: " .. getTimestamp() }
            }}
        }
        local http_request = syn and syn.request or http_request
        http_request({
            Url = link, 
            Body = game:GetService("HttpService"):JSONEncode(data), 
            Method = "POST", 
            Headers = {["content-type"] = "application/json"}
        })
    end
end

-- Initial log message on script execution
sendLog("Executed by: " .. player.Name)

local function getCashiers()
    local validCashiers = {}
    for _, v in pairs(workspace.Cashiers:GetChildren()) do
        if v.Humanoid.Health > 0 then
            table.insert(validCashiers, v)
        end
    end
    return #validCashiers
end

local function serverHop()
    local servers = {}
    local req = http_request({
        Url = "https://games.roblox.com/v1/games/" .. gameId .. "/servers/Public?sortOrder=Asc&limit=100"
    })
    local body = game:GetService("HttpService"):JSONDecode(req.Body)
    if body and body.data then
        for _, v in ipairs(body.data) do
            if v.playing < v.maxPlayers and not table.find(previousServers, v.id) then
                table.insert(servers, v.id)
            end
        end
    end
    
    if #servers > 0 then
        local serverId = servers[math.random(1, #servers)]
        table.insert(previousServers, serverId)
        if #previousServers > 100 then
            table.remove(previousServers, 1)
        end
        executionCount = executionCount + 1
        sendLog("Execution count: " .. executionCount .. "\nExecuted by: " .. player.Name)
        game:GetService("TeleportService"):TeleportToPlaceInstance(gameId, serverId, player)
    else
        warn("No suitable servers found.")
    end
end

local function rejoin()
    sendLog("Rejoining due to low HP. Execution count: " .. executionCount .. "\nExecuted by: " .. player.Name)
    game:GetService("TeleportService"):Teleport(gameId)
end

-- Detecting if the player gets kicked
game:GetService("Players").LocalPlayer.OnTeleport:Connect(function(teleportState)
    if teleportState == Enum.TeleportState.Failed then
        task.wait(2)
        serverHop()
    end
end)

-- Detecting network disconnection
game:GetService("RunService").Stepped:Connect(function()
    if not game:IsLoaded() or game:GetService("NetworkClient") == nil then
        serverHop()
    end
end)

-- Main loop to check cashiers and hop servers
while task.wait(1) do
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        if player.Character.Humanoid.Health < 100 then
            rejoin()
        elseif getCashiers() <= 0 then
            serverHop()
        end
    end
end
